<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- 1. Enable responsive media queries on mobile -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Two Worlds Private Guide to Rio</title>

  <!-- 2. Force-refresh CSS when you bump the version -->
  <link rel="stylesheet" href="styles.css?v=21" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet/dist/leaflet.css"
  />

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <style>
    /* ---- Local overrides ---- */
    /* Center the subscribe boxes under their prompt */
    #subscribe-top,
    #subscribe-bottom {
      text-align: center;
    }

    /* Yellow “Enter” buttons */
    .subscribe-box button {
      background-color: #f1c40f;
      color: #333;
    }

    /* Slightly larger general links */
    a {
      font-size: 1.1rem;
    }

    /* Back-to-top arrow styling */
    .back-to-top {
      float: right;
      font-size: 1.25rem;
      text-decoration: none;
      margin-top: -0.5em;
    }
  </style>

  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-FLGDD5F7R0"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-FLGDD5F7R0');
  </script>
  <script>
  (function() {
    const depths = [25, 50, 75];
    let fired = {};
    window.addEventListener('scroll', () => {
      const pct = Math.round((window.scrollY + window.innerHeight) /
                            document.body.scrollHeight * 100);
      depths.forEach(d => {
        if (pct >= d && !fired[d]) {
          fired[d] = true;
          gtag('event', 'scroll_depth', {
            'scroll_percent': d,
            'page_path': location.pathname
          });
        }
      });
    });
  })();
  </script>
  <script type="text/javascript">
      (function(c,l,a,r,i,t,y){
          c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
          t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
          y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", "thix1ptsal");
  </script>
</head>
<body id="top">
  <!-- … your header/sections up to Restaurants … -->

  <section id="restaurants">
    <h2>Restaurants</h2>

    <div class="restaurant-controls">
      <span class="price-options">
        <input type="checkbox" id="price1" value="$" checked>
        <label for="price1">$</label>
        <input type="checkbox" id="price2" value="$$" checked>
        <label for="price2">$$</label>
        <input type="checkbox" id="price3" value="$$$" checked>
        <label for="price3">$$$</label>
      </span>

      <label class="favorites-toggle">
        <input type="checkbox" id="show-favorites-only"> ⭐ Show only favorites
      </label>
    </div>

    <!-- Map container -->
    <div id="restaurant-map" style="width:100%; height:400px; margin-bottom:1em;"></div>

    <!-- Flat list of all restaurants -->
    <ul id="restaurant-list">
      <!-- all your <li id="…" data-lat="…" data-lng="…" …> entries as before -->
      <!-- e.g. Sheraton, Café e Mar, Amazônia Soul, etc. -->
    </ul>
  </section>

  <!-- … rest of your HTML (Beaches, Viewpoints, etc.) unchanged … -->

  <!-- Your existing subscription, translate, and other scripts remain here … -->

  <!-- === NEW unified filter & map script === -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // 1) Initialize map
    const map = L.map('restaurant-map').setView([-22.97, -43.18], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // 2) Grab UI and list items
    const priceCheckboxes = document.querySelectorAll('.price-options input');
    const favToggle       = document.getElementById('show-favorites-only');
    const listContainer   = document.getElementById('restaurant-list');
    const listItems       = Array.from(listContainer.children);

    // 3) Build markers and type‐layer groups
    const markers    = [];
    const typeLayers = {};

    listItems.forEach(li => {
      const lat = parseFloat(li.dataset.lat);
      const lng = parseFloat(li.dataset.lng);
      if (isNaN(lat) || isNaN(lng)) return;

      // Marker & popup
      const name = li.querySelector('a').textContent.trim();
      const meta = li.querySelector('.restaurant-meta').textContent.trim();
      const marker = L.marker([lat, lng]).bindPopup(`
        <strong>${name}</strong><br>
        <small>${meta}</small><br>
        <a href="#${li.id}">View details ↓</a>
      `);

      // Meta for filtering
      marker.meta = {
        type:     li.dataset.type,
        price:    li.dataset.price,
        favorite: li.dataset.favorite === 'true'
      };
      markers.push(marker);

      // Add to its type layer (create if missing)
      const t = marker.meta.type;
      if (!typeLayers[t]) {
        typeLayers[t] = L.layerGroup().addTo(map);
      }
      typeLayers[t].addLayer(marker);
    });

    // 4) Only type overlays in control (no location layers)
    L.control.layers(
      /* baseLayers */ {},
      /* overlays  */ typeLayers,
      { collapsed: false, position: 'topright' }
    ).addTo(map);

    // 5) Sync function: applies price, favorite & type filters
    function updateFilters() {
      // a) Which prices/favorites are allowed?
      const allowedPrices = Array.from(priceCheckboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);
      const showFavs = favToggle.checked;

      // b) Which type‐overlays are ON?
      const activeTypes = Object.entries(typeLayers)
        .filter(([_, layer]) => map.hasLayer(layer))
        .map(([type]) => type);

      // c) Show/hide list items
      listItems.forEach(li => {
        const okPrice = allowedPrices.includes(li.dataset.price);
        const okFav   = !showFavs || li.dataset.favorite === 'true';
        const okType  = activeTypes.includes(li.dataset.type);
        li.style.display = (okPrice && okFav && okType) ? '' : 'none';
      });

      // d) Rebuild markers in each active type group
      Object.values(typeLayers).forEach(layer => layer.clearLayers());
      markers.forEach(m => {
        const { type, price, favorite } = m.meta;
        if (
          allowedPrices.includes(price) &&
          (!showFavs || favorite) &&
          activeTypes.includes(type)
        ) {
          typeLayers[type].addLayer(m);
        }
      });
    }

    // 6) Wire up all controls & map events
    priceCheckboxes.forEach(cb => cb.addEventListener('change', updateFilters));
    favToggle     .addEventListener('change',   updateFilters);
    map           .on('overlayadd',    updateFilters);
    map           .on('overlayremove', updateFilters);

    // 7) Initial sync
    updateFilters();
  });
  </script>
  <!-- === end unified filter & map script === -->

</body>
</html>
